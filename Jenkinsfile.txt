import org.json.JSONObject

pipeline {
    environment {

        // github settings 

        def branchName = "master"
        def repoName = "petapi"

        // hipchat settings 

        //def hipchatroom = ""

        // slack settings

        def slackchannel = "postmantest" 

        // general settings

        def pipeline = "test_postman"       
    }

    agent any  

    stages {  

        stage('PullScript') {
            steps {             
                checkout poll: false, 
                scm: [$class: 'GitSCM', 
                    branches: [[name: "*" + branchName]], 
                    doGenerateSubmoduleConfigurations: false, 
                    extensions: [[$class: 'CloneOption', 
                                                depth: 0, 
                                                noTags: false, 
                                                reference: '', 
                                                shallow: false, 
                                                timeout: 60]], 
                    submoduleCfg: [], 
                    userRemoteConfigs: [[credentialsId: '', url: 'https://github.com/samsagar14/' + repoName  + '.git']]]
            }
        }
        
        stage('Execute Scripts'){
            steps {
            
                echo "Start Automated API Testing"

                load "${WORKSPACE}/runtests_QA1_SMOKE_CRITICAL.txt"
                
                script {

                    if(fileExists('NewmanResults')) {
                        bat 'rmdir /s /q NewmanResults'
                    } 
                    
                    bat 'mkdir NewmanResults'
                                    
                }   
                                
                script {
                    tests.each {
                        bat """
                            call newman run "${testsfolder}${it}" -e "${environment}" --reporters html,junit --reporter-html-export "${reporters}//${it.minus(".json")}.html" --reporter-junit-export "${reporters}//${it.minus(".json")}.xml"
                            IF %ERRORLEVEL% NEQ 0 Echo An error was found
                            exit /B
                        """
                    }
                }
            }
        }

        stage('Publish Newman results'){
            steps{
                echo "Start publishing Newman results"
                publishHTML (target: [
                      allowMissing: false,
                      alwaysLinkToLastBuild: false,
                      keepAll: true,
                      reportDir: 'NewmanResults/',
                      reportFiles: "*.html",
                      reportName: "Newman_Report"
                      ])
            }
        }

stage('Prepare Notification') {
           
            steps{

                bat """
                    SET folder=%WORKSPACE%\\DevOps
                    if not exist %folder% mkdir %folder%
                """
                // get ps script from repo and checkout it to subfolder

                dir('Devops') {
                    checkout scm: [$class: 'GitSCM', 
                            branches: [[name: '*/DIP-777']], 
                            doGenerateSubmoduleConfigurations: false, 
                            extensions: [[$class: 'SparseCheckoutPaths', 
                                            sparseCheckoutPaths: [[path: "Quality Automation/${env.pipeline}"]]]], 
                            submoduleCfg: [], 
                            userRemoteConfigs: [[credentialsId: '', 
                            url: 'https://github.com/samsagar14/devops_jenkins_pipelines.git']]]
                }

                // copy ps script to workspace root

                bat """
                    SET source=%WORKSPACE%\\DevOps\\Quality Automation\\%pipeline%\\api_variables.ps1
                    xcopy /Y "%source%" "%WORKSPACE%"
                """
                echo "Getting API variables from output files..."

                // ps script get test results and details from output xml and put them to file apivar.txt as variables

                // script also create output file "elk" for elasticsearch input using _bulk method

                bat '''
                        powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command %WORKSPACE%\\api_variables.ps1                  
                        EXIT /b
                    '''                            
            }
        }

		
   }
  }